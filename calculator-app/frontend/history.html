<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MathHub Calculator - History</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .history-container {
        max-width: 1000px;
        margin: 0 auto;
      }

      .history-filters {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .filter-select,
      .filter-input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 14px;
      }

      .history-list {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      }

      .history-item:hover {
        background: #f9f9f9;
      }

      .history-item:last-child {
        border-bottom: none;
      }

      .history-info {
        flex: 1;
      }

      .history-operation {
        font-size: 14px;
        color: #666;
        margin-bottom: 5px;
      }

      .history-time {
        font-size: 12px;
        color: #999;
      }

      .history-result {
        font-weight: bold;
        font-size: 16px;
        margin-right: 20px;
        min-width: 100px;
        text-align: right;
      }

      .history-type {
        background: #e3f2fd;
        color: #1976d2;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        margin-right: 15px;
        min-width: 80px;
        text-align: center;
      }

      .history-delete {
        background: #ff5252;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .history-delete:hover {
        background: #ff1744;
      }

      .empty-message {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #4a6fa5;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div class="logo">
          <h1>ðŸ§® MathHub Calculator</h1>
        </div>
        <div class="user-info">
          <span id="usernameDisplay"></span>
          <button
            onclick="window.location.href = 'index.html'"
            class="btn btn-secondary"
          >
            Back to Calculator
          </button>
          <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
      </header>

      <div class="history-container">
        <h2 class="section-title">ðŸ“Š Calculation History</h2>

        <!-- Statistics -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-value" id="totalCalculations">0</div>
            <div class="stat-label">Total Calculations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="basicCount">0</div>
            <div class="stat-label">Basic Calculations</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="advCount">0</div>
            <div class="stat-label">Advanced Calculations</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="history-filters">
          <select
            id="typeFilter"
            class="filter-select"
            onchange="filterHistory()"
          >
            <option value="">All Types</option>
            <option value="basic">Basic</option>
            <option value="advanced">Advanced</option>
            <option value="conversion">Conversion</option>
            <option value="finance">Finance</option>
          </select>

          <input
            type="search"
            id="searchFilter"
            class="filter-input"
            placeholder="Search calculations..."
            onkeyup="filterHistory()"
          />

          <button
            type="button"
            class="btn btn-primary"
            onclick="exportToCSV()"
            style="margin-left: auto"
          >
            ðŸ“¥ Export CSV
          </button>
          <button type="button" class="btn btn-primary" onclick="exportToPDF()">
            ðŸ“¥ Export PDF
          </button>
          <button
            type="button"
            class="btn btn-danger"
            onclick="clearAllHistory()"
          >
            Clear All
          </button>
        </div>

        <!-- History List -->
        <div class="history-list" id="historyList">
          <div class="empty-message">Loading history...</div>
        </div>
      </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
      let allHistory = [];

      // Load history on page load
      window.addEventListener("load", async () => {
        // Check auth
        if (!window.authManager) {
          window.authManager = new AuthManager();
        }

        const token = window.authManager.getToken();
        if (!token) {
          window.location.href = "auth.html";
          return;
        }

        // Setup logout
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            window.authManager.logout();
          });
        }

        // Update username
        const user = window.authManager.getUser();
        if (user) {
          document.getElementById("usernameDisplay").textContent =
            user.username;
        }

        // Load history
        await loadHistory();
      });

      async function loadHistory() {
        try {
          const token = window.authManager.getToken();
          const response = await fetch("http://localhost:8000/api/history", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to load history");
          }

          allHistory = await response.json();
          console.log("History loaded:", allHistory);

          displayHistory(allHistory);
          updateStats();
        } catch (error) {
          console.error("Error loading history:", error);
          document.getElementById("historyList").innerHTML =
            '<div class="empty-message">Error loading history: ' +
            error.message +
            "</div>";
        }
      }

      function displayHistory(history) {
        const container = document.getElementById("historyList");

        if (history.length === 0) {
          container.innerHTML =
            '<div class="empty-message">No calculations yet. Go back and start calculating!</div>';
          return;
        }

        container.innerHTML = history
          .map(
            (item) => `
            <div class="history-item">
                <div class="history-info">
                    <div class="history-operation">${item.expression}</div>
                    <div class="history-time">${formatDate(item.created_at)}</div>
                </div>
                <div class="history-type">${item.operation_type}</div>
                <div class="history-result">${item.result}</div>
                <button class="history-delete" onclick="deleteCalculation(${item.id})">Delete</button>
            </div>
        `,
          )
          .join("");
      }

      function updateStats() {
        const total = allHistory.length;
        const basic = allHistory.filter(
          (h) => h.operation_type === "basic",
        ).length;
        const advanced = allHistory.filter(
          (h) => h.operation_type === "advanced",
        ).length;

        document.getElementById("totalCalculations").textContent = total;
        document.getElementById("basicCount").textContent = basic;
        document.getElementById("advCount").textContent = advanced;
      }

      function filterHistory() {
        const typeFilter = document.getElementById("typeFilter").value;
        const searchFilter = document
          .getElementById("searchFilter")
          .value.toLowerCase();

        const filtered = allHistory.filter((item) => {
          const matchType = !typeFilter || item.operation_type === typeFilter;
          const matchSearch =
            !searchFilter ||
            item.expression.toLowerCase().includes(searchFilter) ||
            item.result.toString().includes(searchFilter);
          return matchType && matchSearch;
        });

        displayHistory(filtered);
      }

      async function deleteCalculation(id) {
        if (!confirm("Delete this calculation?")) return;

        try {
          const token = window.authManager.getToken();
          const response = await fetch(
            `http://localhost:8000/api/history/${id}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (response.ok) {
            await loadHistory();
            alert("Calculation deleted");
          } else {
            alert("Failed to delete");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error deleting calculation");
        }
      }

      async function clearAllHistory() {
        if (!confirm("Delete ALL calculations? This cannot be undone!")) return;

        try {
          const token = window.authManager.getToken();

          // Delete each calculation
          for (let item of allHistory) {
            await fetch(`http://localhost:8000/api/history/${item.id}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            });
          }

          await loadHistory();
          alert("All calculations cleared");
        } catch (error) {
          console.error("Error:", error);
          alert("Error clearing history");
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("id-ID", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      async function exportToCSV() {
        try {
          const token = window.authManager.getToken();
          const response = await fetch(
            "http://localhost:8000/api/history/export/csv",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (!response.ok) {
            throw new Error("Failed to export CSV");
          }

          // Get blob and download
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `calculation_history_${new Date().toISOString().slice(0, 10)}.csv`;
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);

          alert("âœ“ CSV exported successfully!");
          console.log("CSV exported");
        } catch (error) {
          console.error("Error exporting CSV:", error);
          alert("Error exporting CSV: " + error.message);
        }
      }

      async function exportToPDF() {
        try {
          const token = window.authManager.getToken();
          const response = await fetch(
            "http://localhost:8000/api/history/export/pdf",
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            },
          );

          if (!response.ok) {
            throw new Error("Failed to export PDF");
          }

          // Get blob and download
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `calculation_history_${new Date().toISOString().slice(0, 10)}.pdf`;
          document.body.appendChild(link);
          link.click();
          link.remove();
          window.URL.revokeObjectURL(url);

          alert("âœ“ PDF exported successfully!");
          console.log("PDF exported");
        } catch (error) {
          console.error("Error exporting PDF:", error);
          alert("Error exporting PDF: " + error.message);
        }
      }
    </script>
  </body>
</html>
